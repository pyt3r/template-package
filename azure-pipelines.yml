# template pipeline for a template python package

trigger:
  - master

strategy:
  matrix:
    linux:
      imageName: 'ubuntu-latest'
      pythonVersion: '3.7'

pool:
  vmImage: $(imageName)

steps:
  - task: UsePythonVersion@0
    inputs:
      versionSpec: '$(pythonVersion)'
    displayName: 'Use Python $(pythonVersion)'

  - script: |
      export CONDA_ARTIFACT_NAME=conda-build
      echo "##vso[task.setvariable variable=CONDA_ARTIFACT_NAME]$CONDA_ARTIFACT_NAME"
    displayName: Set environment variable

  - script: |
      echo "##vso[task.prependpath]$CONDA/bin"
    displayName: Add conda to PATH

  - script: |
      conda env create --quiet --file ci/test-env-requirements.yml python=$(pythonVersion)
    displayName: Create a conda test env

  - script: |
      source activate test-env
      make lint
    displayName: Running Linter

  - script: |
      source activate test-env
      make conda-build-and-install
    displayName: Build and install the package

  - script: |
      source activate test-env
      make test-package
    displayName: Run tests against the package

  - task: PublishCodeCoverageResults@1
    inputs:
      codeCoverageTool: Cobertura
      summaryFileLocation: '$(System.DefaultWorkingDirectory)/**/coverage.xml'
      reportDirectory: '$(System.DefaultWorkingDirectory)/**/htmlcov'

  - task: CopyFiles@2
    displayName: 'Copy Artifacts'
    inputs:
      SourceFolder: '$(Build.SourcesDirectory)'
      Contents: |
        **/*.tar.bz2
      TargetFolder: '$(Build.ArtifactStagingDirectory)'

  - task: PublishBuildArtifacts@1
    inputs:
      PathtoPublish: '$(Build.ArtifactStagingDirectory)'
      ArtifactName: '$(CONDA_ARTIFACT_NAME)'
      publishLocation: 'Container'
